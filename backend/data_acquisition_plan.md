# データ取得・管理計画

## 基本方針

**レース情報（2015-2022年）を完全にパースし、そこから全ての予想材料を抽出する**

- 11年分のレース情報には騎手・馬・調教師の全てが含まれている
- 統計データは後から計算可能
- 1年程度更新不要な恒久的予想AIを目指す

## ディレクトリ構造

```
backend/data/
├── html/                      # 取得済みHTML（レース情報）
│   ├── 2015/
│   │   └── 20150404/
│   │       ├── race_01_deba.html
│   │       └── race_01_result.html
│   ├── ...
│   └── 2022/
├── reference_data/            # 恒久的参照データ（新設）
│   ├── html/
│   │   └── course_records.html      # コースレコード
│   ├── json/
│   │   └── course_records.json      # パース済み
│   └── README.md
└── parsed/                    # パース済みデータ（既存のYAML等）
    └── yaml/
```

## 取得するデータ

### 1. レース情報（既存・進行中）
**ソース**: `https://www.keiba.go.jp/KeibaWeb/TodayRaceInfo/`

**対象期間**: 2015-2022年（約11年分）

**取得内容**:
- 出馬表（deba.html）
- 結果（result.html）

**含まれる情報**:
- レース情報（日付、レース名、距離、馬場状態、天候）
- 馬情報（馬名、年齢、性別、斤量、馬番、枠番）
- 騎手情報（騎手名）
- 調教師情報（調教師名）
- オッズ（出馬表）
- 着順・タイム（結果）
- 過去成績（出馬表に含まれる）

**状態**: ダウンロード進行中（400/5424件、7.4%）

### 2. コースレコード（新規取得）
**ソース**: `https://www.keiba.go.jp/guide/course_record/?course=kana`

**理由**: レース情報には含まれない恒久的な基準データ

**取得内容**:
- 距離別レコードタイム（900m～2600m）
- レコード達成馬名
- レコード達成騎手名
- 達成日付

**取得方法**: 1回のみ手動または単発スクリプト

**保存先**: `data/reference_data/html/course_records.html`

## パース戦略

### フェーズ1: 既存HTMLのパース（優先）
1. 出馬表HTML → YAML/JSON
2. 結果HTML → YAML/JSON
3. データ構造の正規化

### フェーズ2: データベース統合
1. レース情報から騎手マスタを自動生成
2. レース情報から馬マスタを自動生成
3. レース情報から調教師マスタを自動生成
4. 統計データを計算（勝率・連対率など）

### フェーズ3: 参照データの取得
1. コースレコードの取得・パース
2. 距離マスタとして統合

## データベース設計

### 自動生成するマスタテーブル

**horses** (馬マスタ - レース情報から生成)
- horse_id (PK)
- name (馬名)
- name_kana (読み)
- first_appearance (初出走日)
- last_appearance (最終出走日)

**jockeys** (騎手マスタ - レース情報から生成)
- jockey_id (PK)
- name (騎手名)
- first_race (初騎乗日)
- last_race (最終騎乗日)

**trainers** (調教師マスタ - レース情報から生成)
- trainer_id (PK)
- name (調教師名)

### 計算する統計テーブル

**jockey_stats** (騎手統計 - レース結果から計算)
- jockey_id (FK)
- year
- total_races
- first_count
- second_count
- third_count
- win_rate (計算値)
- place_rate (計算値)

**horse_stats** (馬統計 - レース結果から計算)
- horse_id (FK)
- total_races
- first_count
- win_rate

### 参照データテーブル

**course_records** (コースレコード - 手動取得)
- distance (PK)
- record_time
- horse_name
- jockey_name
- achieved_date

## 予想モデルの特徴量

### レース情報から直接取得
- 枠番、馬番
- 馬齢、性別
- 斤量
- 距離、馬場状態、天候
- オッズ
- 過去3走の成績

### 計算で生成
- 騎手勝率（レース結果から計算）
- 騎手連対率（レース結果から計算）
- 馬の勝率（レース結果から計算）
- 馬の距離適性（レース結果から計算）
- 馬場適性（レース結果から計算）
- 距離とレコードの差（コースレコードと比較）

## 実装タスク

### 優先度1: レースHTMLのパース
- [ ] 出馬表HTMLパーサー改善
- [ ] 結果HTMLパーサー改善
- [ ] 11年分のHTMLを一括パース

### 優先度2: DBスキーマ改善
- [ ] マスタテーブル自動生成スクリプト
- [ ] 統計計算スクリプト
- [ ] データ正規化

### 優先度3: 参照データ取得
- [ ] コースレコード取得スクリプト
- [ ] コースレコードパーサー
- [ ] DB統合

### 優先度4: 予想モデル改善
- [ ] 計算特徴量の実装
- [ ] LightGBM学習スクリプト
- [ ] モデル評価

## 更新戦略

**基本**: 1年に1回程度の更新を想定

1. 新しい年のレース情報を取得
2. HTMLをパース
3. マスタテーブルを更新（新しい騎手・馬を追加）
4. 統計を再計算
5. モデルを再学習

**頻度を下げる理由**:
- 騎手・馬の入れ替わりは年単位
- 過去11年分のデータで十分汎化可能
- スクレイピング負荷の削減
- 保守コストの削減

## メリット

1. **シンプル**: レース情報だけで完結
2. **網羅的**: 11年分の全情報を活用
3. **保守容易**: 追加スクレイピング不要
4. **汎化性能**: 長期間のデータで一般化
5. **低コスト**: 年1回の更新で十分

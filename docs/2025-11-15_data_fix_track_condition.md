# データ修正レポート: 馬場状態抽出の修正

**日付**: 2025-11-15
**対象**: html_to_yaml.py 馬場状態・天候抽出ロジック
**影響範囲**: 全8,718レース

## 問題の概要

### 発見された不具合

1. **馬場状態の偏り**
   - DB検証時、馬場状態が「重」83.21%、「不良」16.79%という極端な偏り
   - 「良」「稍重」が0%という異常な状態

2. **根本原因**
   - html_to_yaml.pyの馬場状態抽出ロジックが順序依存の単純な文字列マッチ
   - 「稍重」に「重」が含まれるため、常に「重」がマッチ
   - HTMLの「馬場：良」も正しく抽出できていなかった

## 実施した修正

### 修正箇所

`backend/html_to_yaml.py` 566-582行目

### 修正内容

#### 修正前（不具合あり）
```python
# 馬場状態を抽出
track_condition = "不明"
try:
    for cond in ["不良", "重", "稍重", "良"]:
        if cond in info_text:
            track_condition = cond
            break
except Exception as e:
    print(f"馬場状態抽出エラー: {e}")

# 天候を抽出
weather = "不明"
try:
    for w in ["雪", "雨", "曇", "晴"]:
        if w in info_text:
            weather = w
            break
except Exception as e:
    print(f"天候抽出エラー: {e}")
```

**問題点**:
- 順序依存のループで最初にマッチした文字列を採用
- 「稍重」を含むテキストでも「重」が先にマッチ
- 「馬場：」の直後の値を抽出していないため、誤った箇所の文字列をマッチさせる可能性

#### 修正後（正常動作）
```python
# 馬場状態を抽出（正規表現で「馬場：」の直後を取得）
track_condition = "不明"
try:
    track_match = re.search(r'馬場[：:]\s*(不良|稍重|重|良)', info_text)
    if track_match:
        track_condition = track_match.group(1)
except Exception as e:
    print(f"馬場状態抽出エラー: {e}")

# 天候を抽出（正規表現で「天候：」の直後を取得）
weather = "不明"
try:
    weather_match = re.search(r'天候[：:]\s*(雪|雨|曇|晴)', info_text)
    if weather_match:
        weather = weather_match.group(1)
except Exception as e:
    print(f"天候抽出エラー: {e}")
```

**改善点**:
- 正規表現で「馬場：」「天候：」の直後の値を正確に抽出
- 全角・半角コロンの両方に対応 `[：:]`
- 選択肢の順序に依存せず、実際のHTML内容をそのまま抽出
- 「稍重」が「重」より優先的にマッチ（正規表現の選択肢の順序）

## 検証結果

### テストケース

**HTMLソース** (`data/html/2016/20161025/race_02_result.html`):
```
天候：曇　馬場：良
```

**修正前のYAML出力**:
```yaml
track_condition: 重  # ❌ 誤り
weather: 曇
```

**修正後のYAML出力**:
```yaml
track_condition: 良  # ✅ 正しい
weather: 曇
```

### 実データ確認

HTMLファイル内の「馬場：良」の出現回数:
```bash
$ grep -r "馬場：良" backend/data/html/ | wc -l
11696
```

→ 約11,696レースで「良」が存在するはずが、修正前は0件しか抽出されていなかった

## 実施した作業

1. ✅ 馬場状態抽出ロジックを正規表現に修正
2. ✅ テストケースで動作確認（「良」が正しく抽出）
3. ✅ 全8,718件のYAMLファイルを再生成
4. 🔄 DBを再初期化
5. 🔄 新YAMLを全件再インポート
6. ⏳ 最終データ品質検証

## 期待される結果

### 修正前（異常）
- 良: 0%
- 稍重: 0%
- 重: 83.21%
- 不良: 16.79%

### 修正後（期待）
- 良: 約60-70%（晴れや曇りの日が多い）
- 稍重: 約10-15%
- 重: 約10-15%
- 不良: 約5-10%

## 今後の課題

- 性別データの抽出改善（現在25.54%のみ）
  → result.yamlには性別情報が含まれるが、horsesテーブルが空のため
  → deba.yamlのインポート実装が必要

## まとめ

単純な文字列マッチから正規表現による正確な抽出に変更することで、馬場状態データの品質が大幅に改善される見込み。この修正により、機械学習モデルの精度向上が期待できる。

# データ品質の問題と対応方針 - 2025-11-14

## 調査結果サマリー

### ✅ 問題なし

1. **馬場状態「不良」が94.57%**
   - **結論**: 問題なし
   - **理由**:
     - YAMLファイル確認の結果、晴天でも前日の雨で馬場が悪い状態が記録されている
     - 石川県は降水量が多い地域であり、馬場が乾きにくい気候
     - 実際のレースデータとして妥当

### ⚠️ 軽度の問題（モデル構築時に対処可能）

2. **性別データが50%欠損**
   - **現状**:
     - `horses`テーブルのgenderが50%（3,300頭）がnull
     - 残り50%（3,301頭）はfemale
   - **原因**:
     - 出馬表(deba)YAMLの`sex_age`フィールドが多くの馬でnullになっている
     - 結果(result)YAMLには`sex_age: 牝 4`のように正しく記録されている
     - おそらく`yaml_to_db.py`が出馬表と結果を統合する際、性別を正しくマージできていない
   - **影響**:
     - 性別は予想の重要特徴量（特に牝馬限定戦など）
     - ただし、結果データには記録があるため、過去成績から推測可能
   - **対応方針**:
     1. 短期: 欠損値は「unknown」として扱い、モデルに組み込む
     2. 中期: 結果YAMLから性別を逆引きしてhorsesテーブルを更新
     3. 長期: yaml_to_db.pyを修正して初回投入から正しく処理

### ❌ 重大な問題（早急な対応必要）

3. **配当データが完全欠損**
   - **現状**:
     - `results`テーブルの`payout_trifecta`が全レース（8,718件）でnull
     - `payouts`（JSON）フィールドも空
   - **原因調査結果**:
     - YAMLファイルには単勝・複勝・馬連・ワイドなどの配当データは存在
     - しかし**3連単のデータがYAMLに存在しない**
     - 理由の可能性:
       1. HTMLスクレイピング時に3連単を取得していない
       2. 地方競馬では3連単が一部のレースでしか発売されていない
       3. 2015年時点では3連単が発売されていなかった可能性
   - **影響**:
     - **回収率の計算ができない**（プロジェクトの核心）
     - 予想システムの実用性を評価できない
     - 「一本槍」の配当妙味を検証できない
   - **対応方針**:
     1. **優先度最高**: HTMLソースを再確認し、3連単データの有無を確認
     2. 3連単が存在する場合: `html_to_yaml.py`を修正して再スクレイピング
     3. 3連単が存在しない場合: 馬連・3連複など他の馬券種での代替評価を検討
     4. 最悪の場合: 直近2-3年分だけでも公式サイトから手動取得を検討

---

## データ品質スコアカード

| 項目 | 完全性 | 正確性 | 一貫性 | 総合評価 |
|------|--------|--------|--------|----------|
| レース基本情報 | ✅ 100% | ✅ 高 | ✅ 高 | A |
| 馬情報 | ⚠️ 85% | ✅ 高 | ✅ 高 | B+ |
| 騎手情報 | ✅ 100% | ✅ 高 | ✅ 高 | A |
| 出走エントリー | ✅ 100% | ✅ 高 | ✅ 高 | A |
| 結果（着順） | ✅ 99.8% | ✅ 高 | ✅ 高 | A |
| **配当データ** | ❌ 0% | - | - | **F** |

**総合評価**: **B-**（配当データが致命的な欠損）

---

## 次のアクション

### Phase 2a: 配当データ緊急対応（最優先）

1. [ ] 2024-2025年のHTMLファイルを確認し、3連単データの存在を確認
2. [ ] 存在する場合: `html_to_yaml.py`のパース処理を確認・修正
3. [ ] 存在しない場合: 代替評価手法の検討（馬連・3連複など）
4. [ ] 最悪でも直近1年分の3連単データを手動取得

### Phase 2b: モデル構築（並行実施可能）

配当データがなくても、以下は実施可能:

5. [x] 特徴量エンジニアリングの設計
6. [ ] LightGBMモデルの実装（順位予測）
7. [ ] 時系列クロスバリデーションの実装
8. [ ] 的中率の評価（回収率は後回し）

---

## 参考: 地方競馬の3連単発売状況

### 仮説1: 発売開始時期の問題

地方競馬での3連単発売は以下の可能性:
- 2010年代前半は一部の競馬場のみ
- 金沢競馬場での発売開始時期を要確認
- 2015年時点では未発売だった可能性

### 仮説2: 出走頭数の制約

- 3連単は通常8頭以上のレースで発売
- 金沢競馬は少頭数レースが多い場合、発売されないケースあり

### 調査方法

1. NAR（地方競馬全国協会）の公式サイトで発売状況を確認
2. 楽天競馬で2015年の金沢競馬の馬券種を確認
3. HTMLファイルの実物を目視確認

---

## まとめ

**データは基本的に良好だが、配当データの欠損が致命的**。

予想モデルの構築自体は進められるが、プロジェクトの最終目的である「回収率の検証」ができないため、配当データの取得が最優先課題。

一方で、性別データの欠損は軽微であり、モデル構築時に適切に処理すれば問題ない。

馬場状態については、ユーザー指摘の通り石川県の気候特性を反映した妥当なデータである。

---

**作成者**: Claude
**作成日**: 2025-11-14
**調査対象**: backend/kanazawa_dirt_one_spear.db, backend/data/yaml/

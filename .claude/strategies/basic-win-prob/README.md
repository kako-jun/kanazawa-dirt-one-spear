# 作戦: 王道 (Royal Road)

**ID**: `basic-win-prob`
**バージョン**: 1.0.0
**ステータス**: ✅ 訓練完了（2025-11-20）

## 概要

最もシンプルで理解しやすい3連単予想アプローチ。

LightGBMを使って各馬の**1着確率を予測**し、確率が高い上位3頭を組み合わせて3連単を構築する。

## 仮説

- 過去の成績データから未来の成績を予測できる
- 馬・騎手・調教師の累積統計が有効な特徴量
- 馬場状態や距離などのレース条件が結果に影響する
- 人気（オッズ）情報は予測精度を向上させる

## アルゴリズム

### モデル

#### 1. オッズなしモデル
**用途**: レース前の事前予想

**特徴量**:
- 馬の累積成績（勝率、複勝率、平均着順、休養日数）
- 騎手の累積成績（勝率、複勝率）
- 調教師の累積成績（勝率、複勝率）
- レース条件（馬場状態、距離カテゴリ）
- 枠番、馬番

#### 2. オッズありモデル
**用途**: オッズ発表後の最終予想

**特徴量**:
- 上記すべて + 人気順位

### 予想方法

```
1. 各馬の1着確率を予測
   horse_1: 0.25
   horse_2: 0.18
   horse_3: 0.15
   horse_4: 0.12
   ...

2. 上位3頭を選択
   1着候補: horse_1 (25%)
   2着候補: horse_2 (18%)
   3着候補: horse_3 (15%)

3. 3連単を構築
   推奨: 1-2-3
```

## 実装

- 特徴量生成: `analysis/feature_engineering_v2.py`
- モデル訓練: `analysis/train_lightgbm.py`
- 使用テーブル:
  - stat_horse_cumulative
  - stat_jockey_cumulative
  - stat_trainer_cumulative

## 実行方法

```bash
# 1. 特徴量生成（既に実行済み）
cd backend
uv run python ../analysis/feature_engineering_v2.py

# 2. モデル訓練（GPU環境推奨）
uv run python ../analysis/train_lightgbm.py
```

## リスク・課題

### 1. クラス不均衡（重要度: 高）
- 8頭立てなら1着は1/8 = 12.5%
- 正例が極端に少ない
- **対策**: クラス重み付け、SMOTE検討

### 2. 3連単の組み合わせ爆発
- 上位3頭を固定すると柔軟性に欠ける
- **対策**: 上位N頭から複数パターン生成

### 3. 配当を考慮していない
- 的中率が高くても配当が低ければ収益は出ない
- **対策**: 期待値ベースの選択に移行

## 改善案

1. **ランク学習への移行**
   - LambdaMART、LambdaRankを使用
   - 順位を直接予測する

2. **アンサンブル学習**
   - 複数モデルの予測を組み合わせ
   - 馬特化、騎手特化、条件特化など

3. **期待値最適化**
   - 配当を考慮した選択
   - オッズと予測確率のギャップを利用

## 訓練結果（2025-11-20）

### モデル性能（5-fold CV平均）

#### オッズなしモデル
- ROC-AUC: **72.79%** (±2.21%)
- Accuracy: 88.53% (±0.19%)
- Recall: 0.68% (±0.26%) ⚠️ **要改善**
- F1 Score: 1.34% (±0.51%)

#### オッズありモデル
- ROC-AUC: **84.03%** (±1.16%) ✓ **優秀**
- Accuracy: 89.09% (±0.15%)
- Recall: 23.77% (±4.46%) ✓ **実用的**
- F1 Score: 33.04% (±4.42%)

### 主な発見

1. **オッズ情報の効果は絶大**
   - ROC-AUC: 72.79% → 84.03% (+11.24pt)
   - Recall: 0.68% → 23.77% (35倍改善)

2. **クラス不均衡の影響**
   - 1着は全体の11.32%のみ
   - オッズなしモデルのRecallが極端に低い

3. **実用性の評価**
   - オッズありモデルは実戦投入可能なレベル
   - 約4レースに1回、1着馬を捕捉

### 生成ファイル
- `analysis/output/models/lightgbm_no_odds.pkl` (258KB)
- `analysis/output/models/lightgbm_with_odds.pkl` (284KB)
- `analysis/output/models/training_report_20251120.md` - 詳細レポート
- `analysis/output/models/model_comparison.csv` - 性能比較表
- `analysis/output/models/feature_importance_*.png/csv` - 特徴量重要度

## 次のステップ

- [x] GPU環境で訓練実行（2025-11-20完了）
- [x] 性能評価（Accuracy, ROC-AUC, etc.）（2025-11-20完了）
- [ ] クラス重み付けによる再訓練（Recall改善）
- [ ] バックテスト（過去データで検証）
- [ ] 3連単構築ロジック実装
- [ ] API実装（予想エンドポイント）
- [ ] 他作戦との比較

---

**作成日**: 2025-11-15
**最終更新**: 2025-11-20（訓練完了）

strategy_id: "trifecta-pattern-learning"
display_name: "3連単パターン学習型"
display_name_en: "Trifecta Pattern Learning"
version: "1.0.0"

hypothesis:
  title: "3連単の『型』を直接学習する"
  description: |
    「1番人気-2番人気-4番人気」「逃げ馬-差し馬-追込馬」など、
    3連単には特定の"パターン"が存在する。個々の馬の実力ではなく、
    **レース全体の構図・組み合わせパターン**を直接学習することで
    3連単に特化した予測を実現する。

  assumptions:
    - 3連単には再現性のあるパターンが存在する
    - 人気の組み合わせパターン（例: 1-3-5）が統計的に偏っている
    - 脚質の組み合わせパターン（例: 逃げ-先行-差し）に傾向がある
    - 騎手・調教師の組み合わせにも相性がある
    - パターンを直接予測することで3連単の精度が上がる

algorithm:
  type: "pattern_recognition + classification"
  models:
    - name: "Popularity Pattern Classifier"
      purpose: "人気の組み合わせパターンを予測"
      method: |
        過去の3連単パターンを学習:
        - 「1-2-3番人気」: 15%
        - 「1-2-4番人気」: 10%
        - 「1-3-5番人気」: 8%
        ...
        レース条件から最も起こりやすいパターンを予測

    - name: "Running Style Pattern Classifier"
      purpose: "脚質の組み合わせパターンを予測"
      method: |
        - 「逃げ-先行-差し」: 20%
        - 「逃げ-差し-追込」: 12%
        - 「先行-差し-差し」: 18%
        ペース予測と組み合わせて最適パターンを選択

    - name: "Combination Frequency Model"
      purpose: "頻出組み合わせを学習"
      method: |
        馬の特徴ベクトルから組み合わせパターンをクラスタリング:
        - クラスタA（強い順当決着パターン）
        - クラスタB（中穴混じりパターン）
        - クラスタC（大波乱パターン）
        レース条件からクラスタを予測

  prediction_method: |
    1. レース条件を分析
       - 馬場状態、距離、人気分布、脚質分布

    2. 最も起こりやすいパターンを予測
       例: このレースは「1-3-5番人気」パターンが来やすい

    3. パターンに該当する馬の組み合わせを抽出
       実際の1番人気、3番人気、5番人気の馬を選択

    4. 3連単構築: 1番人気-3番人気-5番人気

    alternative:
      複数パターンの確率を計算し、最も高いパターンを選択

implementation:
  scripts:
    - path: "analysis/trifecta_pattern_learning/extract_patterns.py"
      purpose: "過去の3連単パターン抽出"
    - path: "analysis/trifecta_pattern_learning/pattern_frequency.py"
      purpose: "パターン頻度分析"
    - path: "analysis/trifecta_pattern_learning/train_pattern_classifier.py"
      purpose: "パターン分類器訓練"
    - path: "analysis/trifecta_pattern_learning/predict_pattern.py"
      purpose: "パターン予測"

  required_tables:
    base:
      - races
      - horses
      - jockeys
      - trainers
      - entries
      - race_performances
      - payouts  # 過去の3連単結果
    derived:
      - trifecta_patterns  # パターン履歴（要作成）

priority: "high"
status: "planned"
last_updated: "2025-11-16"

performance:
  experiments: []
  best_metrics: null
  target_metrics:
    - hit_rate: "> 7%"
    - pattern_prediction_accuracy: "> 30%"

risks:
  - issue: "パターン数が多すぎて学習困難"
    severity: "medium"
    mitigation: "パターンをグループ化、抽象化"

  - issue: "稀なパターンは学習できない"
    severity: "low"
    mitigation: "頻出パターンに絞る"

  - issue: "オーバーフィッティング"
    severity: "medium"
    mitigation: "正則化、交差検証"

improvements:
  - "ディープラーニングでパターン埋め込み"
  - "類似パターンのクラスタリング"
  - "条件別のパターン分布学習"

next_steps:
  - "過去の3連単パターン抽出"
  - "頻出パターンの特定"
  - "パターン分類器実装"
  - "basic-win-probとの比較"
